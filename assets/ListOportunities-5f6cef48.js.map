{"version":3,"file":"ListOportunities-5f6cef48.js","sources":["../../src/pages/oportunities/pages/ListOportunities.vue"],"sourcesContent":["<script setup lang=\"ts\">\nimport { onMounted, ref, watch } from 'vue'\nimport NewOportunity from './NewOportunity.vue'\nimport { deleteOportunity, getAllOportunities } from '../../../core/requests/Oportunities'\nimport { useToast } from 'vuestic-ui/web-components'\nimport { format } from 'date-fns'\nimport { newOrder } from '../../../core/requests/Orders'\nimport { useRouter } from 'vue-router'\nimport { useOrdersStore } from '../../../stores/orders-store'\nimport { storeToRefs } from 'pinia'\nimport { useOportunitiesStore } from '../../../stores/oportunities-store'\nimport { HOST } from '../../../core/constants'\n\nconst { notify } = useToast()\nconst router = useRouter()\nconst items = ref([])\nconst columns = [\n  { key: 'id', sortable: false },\n  { key: 'Descripción', sortable: false },\n  { key: 'Cliente', sortable: false },\n  { key: 'Servicios', sortable: false },\n  { key: 'Total', sortable: false },\n  { key: 'Comercial', sortable: false },\n  { key: 'Creación', sortable: false },\n  { key: 'Estado', sortable: false },\n  { key: 'actions', width: 80 },\n]\nconst orderStore = useOrdersStore()\nconst { viewOrders, orders } = storeToRefs(orderStore)\nconst oportunityStore = useOportunitiesStore()\nconst { statusOptions } = storeToRefs(oportunityStore)\n\nconst showConfirm: any = ref(null)\nconst showConfirmStatus: any = ref(null)\nconst showEdit: any = ref(null)\nconst onlyPreview = ref(false)\nconst showNewOportunity = ref(false)\nconst isDeleting = ref(false)\nconst isLoading = ref(false)\nconst isOnChangeStatus: any = ref(0)\n//\nconst inputSearch = ref('')\nconst startDate = ref({\n  start: null,\n  end: null,\n})\nconst filteredCount = ref(0)\nconst perPage = ref(15)\nconst currentPage = ref(1)\nconst pages = () => {\n  console.log(items.value.length)\n  return perPage.value && perPage.value !== 0 ? Math.ceil(items.value.length / perPage.value) : items.value.length\n}\n//\nconst doDelete = async () => {\n  await deleteOportunity(showConfirm.value)\n  showConfirm.value = null\n\n  notify({\n    message: 'Cotización eliminada correctamente',\n    color: 'success',\n    duration: 1000,\n  })\n\n  getData()\n}\n\nconst getData = async (filter?: any) => {\n  isLoading.value = true\n  const data: any = await getAllOportunities(filter)\n  await oportunityStore.getQuotationStates()\n\n  items.value = data.map((e: any) => {\n    const state = { state: { ...e }.status }\n    return {\n      data: {\n        ...e,\n        ...state,\n      },\n      createdAt: format(new Date(e.created_at), 'dd/MM/yyyy hh:mm'),\n      Creación: format(new Date(e.created_at), 'dd/MM/yy hh:mm'),\n      updatedAt: format(new Date(e.updated_at), 'dd/MM/yyyy hh:mm'),\n      id: '00' + e.id,\n      Cliente: e.customer.company ? e.customer.socialreason : '' + e.customer.fullname,\n      Servicios: e.services.map((e: any) => ({ label: e.service.detail?.service, value: e.service.detail?.id })),\n      Total: 'S/ ' + e.total,\n      Descripción: e.title,\n      Comercial: e.owner?.name,\n      Acciones: true,\n    }\n  })\n\n  isLoading.value = false\n}\nconst openPreview = (item: any) => {\n  showEdit.value = item\n  onlyPreview.value = true\n}\nconst closeNew = () => {\n  getData()\n  onlyPreview.value = false\n  showNewOportunity.value = false\n}\nconst onChangeStatus = async (data: any) => {\n  oportunityStore.setActiveOportunity(data)\n  oportunityStore.viewConfirm()\n}\nconst cancelStatus = () => {\n  showConfirmStatus.value = null\n}\nconst doChangeStatus = () => {}\nonMounted(() => {\n  watch(\n    () => oportunityStore.vailable,\n    () => {\n      console.log('updated')\n    },\n  )\n  getData()\n})\nconst openOrder = async (id: any) => {\n  isLoading.value = true\n\n  const order: any = await newOrder({\n    id,\n  })\n  const newOrders = order.news\n  const exists = order.exists\n\n  if (exists.length > 0) {\n    notify({\n      message: 'La cotización tiene ordenes existentes',\n      color: 'info',\n      duration: 2500,\n    })\n    orderStore.showOrders(exists)\n    isLoading.value = false\n  } else {\n    if (newOrders.length > 1) {\n      notify({\n        message: 'Proceso realizado correctamente',\n        color: 'success',\n        duration: 2500,\n      })\n      orderStore.showOrders(newOrders)\n      isLoading.value = false\n    } else {\n      notify({\n        message: 'Se ha creado la orden #000' + newOrders[0] + '-24',\n        color: 'success',\n        duration: 2500,\n      })\n      isLoading.value = false\n      router.push('/orders/view/' + newOrders[0])\n    }\n  }\n}\nconst doFilterByRange = () => {\n  const { start, end } = startDate.value\n  if (start && end) {\n    const fromDate = new Date(start).setHours(0)\n    const toDate = new Date(end).setHours(24)\n    getData({\n      start: new Date(fromDate).getTime(),\n      end: new Date(toDate).getTime(),\n    })\n  }\n}\nconst isDownloading = ref(false)\nconst download = () => {\n  isDownloading.value = true\n  setTimeout(() => {\n    isDownloading.value = false\n  }, 2000)\n  console.log('download')\n}\nconst isLoadingPDF = ref(null)\nconst togglePdfLoading = (id: any) => {\n  isLoadingPDF.value = id\n\n  setTimeout(() => {\n    isLoadingPDF.value = null\n  }, 2500)\n}\n</script>\n\n<template>\n  <div class=\"py-4\">\n    <div class=\"flex flex-wrap sm:flex-nowrap justify-between align-center justify-center\">\n      <h1 class=\"h5 m-0\">Cotizaciones ({{ items.length }})</h1>\n\n      <div class=\"flex gap-2\">\n        <VaButton\n          icon=\"exit_to_app\"\n          color=\"info\"\n          :loading=\"isDownloading\"\n          :href=\"HOST + '/oportunities/xls'\"\n          @click=\"download\"\n        >\n          <span class=\"px-1\">Descargar</span>\n        </VaButton>\n        <VaButton icon=\"add\" color=\"primary\" @click=\"showNewOportunity = true\">\n          <span class=\"px-1\">Nueva cotización</span>\n        </VaButton>\n      </div>\n    </div>\n\n    <div class=\"columns-1 sm:columns-5 mb-7 mt-5\">\n      <div>\n        <VaInput\n          v-model=\"inputSearch\"\n          label=\"Buscar en resultados\"\n          placeholder=\"Escribe lo que buscas\"\n          clearable\n          background=\"#fff\"\n        />\n      </div>\n      <div>\n        <VaDateInput\n          v-model=\"startDate\"\n          label=\"Filtrar por fecha\"\n          placeholder=\"Ingresa una fecha\"\n          mode=\"range\"\n          background=\"#fff\"\n          @update:modelValue=\"doFilterByRange\"\n        />\n      </div>\n      <div class=\"relative\">\n        <VaSelect\n          :options=\"statusOptions\"\n          value-by=\"id\"\n          text-by=\"label\"\n          background=\"#fff\"\n          placeholder=\"---\"\n          label=\"Filtrar por estado\"\n          class=\"text-xs\"\n          style=\"--va-input--border-color: transparent; width: 120px\"\n        />\n\n        <VaButton class=\"absolute bottom-0.5 mx-4 text-xs\" color=\"#158de3\">Buscar</VaButton>\n      </div>\n    </div>\n\n    <div class=\"flex columns-1 mt-5\">\n      <div class=\"w-full bg-white p-2\">\n        <VaDataTable\n          :items=\"items\"\n          :columns=\"columns\"\n          class=\"text-xs\"\n          :filter=\"inputSearch\"\n          :per-page=\"perPage\"\n          :current-page=\"currentPage\"\n          :loading=\"isLoading\"\n          :no-data-html=\"'...'\"\n          @filtered=\"filteredCount = $event.items.length\"\n        >\n          <template #cell(actions)=\"{ row }\">\n            <div class=\"flex gap-1\">\n              <VaButton\n                icon=\"delete\"\n                color=\"danger\"\n                :disabled=\"row.itemKey.data.status === 4\"\n                round\n                @click=\"showConfirm = row.itemKey.data.id\"\n              ></VaButton>\n              <VaButton\n                icon=\"download\"\n                color=\"#158de3\"\n                round\n                :loading=\"row.itemKey.data.id == isLoadingPDF\"\n                :href=\"HOST + '/oportunities/pdf/' + row.itemKey.data.id\"\n                @click=\"togglePdfLoading(row.itemKey.data.id)\"\n              ></VaButton>\n              <VaButton icon=\"visibility\" color=\"#6c48d9\" round @click=\"openPreview(row.itemKey.data)\"></VaButton>\n              <VaButton\n                v-if=\"row.itemKey.data.status === 4\"\n                icon=\"library_add\"\n                color=\"success\"\n                round\n                @click=\"openOrder(row.itemKey.data.id)\"\n              ></VaButton>\n              <!-- <VaButton\n                :icon=\"isExpanded ? 'va-arrow-up' : 'va-arrow-down'\"\n                preset=\"primary\"\n                @click=\"row.toggleRowDetails()\"\n              >\n              </VaButton> -->\n            </div>\n          </template>\n\n          <template #cell(Descripción)=\"{ ...value }\">\n            <p class=\"break-words text-balance\">\n              {{ value?.source }}\n            </p>\n          </template>\n\n          <template #cell(Estado)=\"{ row }\">\n            <VaSelect\n              v-model=\"row.itemKey.data.status\"\n              :background=\"\n                row.itemKey.data.status === 4 ? '#c3ffcb' : row.itemKey.data.status === 5 ? '#ffa1a1' : '#d5e3ff'\n              \"\n              :readonly=\"row.itemKey.data.status === 4\"\n              :options=\"statusOptions\"\n              value-by=\"id\"\n              text-by=\"label\"\n              placeholder=\"---\"\n              :loading=\"isOnChangeStatus === row.itemKey.data.id\"\n              class=\"text-xs\"\n              style=\"--va-input--border-color: transparent; width: 120px\"\n              @update:modelValue=\"onChangeStatus(row.itemKey.data)\"\n            />\n          </template>\n\n          <template #cell(Servicios)=\"{ ...value }\">\n            <div class=\"flex flex-col gap-1\" style=\"--va-badge-text-wrapper-border-radius: 50%\">\n              <VaBadge v-for=\"i in value?.source\" :key=\"i\" overlap>\n                <VaChip\n                  size=\"small\"\n                  color=\"#d5e3ff\"\n                  class=\"text-xxs font-bold px-1\"\n                  style=\"--va-chip-sm-height: 1.25rem\"\n                >\n                  {{ i.label }}\n                </VaChip>\n              </VaBadge>\n            </div>\n          </template>\n\n          <template #expandableRow=\"{ rowData }\">\n            <div class=\"mx-10 my-2 px-2 py-3 gap-2 bg-blue-50\">\n              <div class=\"columns-4 w-full mb-4 bg-white p-2\">\n                <div>\n                  <p class=\"font-bold\">Cotización creada:</p>\n                  <span>{{ rowData.createdAt }}</span>\n                </div>\n\n                <div>\n                  <p class=\"font-bold\">Última Actualización:</p>\n                  <span>{{ rowData.updatedAt }}</span>\n                </div>\n              </div>\n\n              <div class=\"bg-white p-2\">\n                <div class=\"columns-4 w-full mb-2\">\n                  <div class=\"w-full\">\n                    <p class=\"font-bold\">Cotizado por:</p>\n                    <span class=\"capitalize\">{{ rowData.data?.owner?.name }}</span>\n                  </div>\n\n                  <div class=\"w-full\">\n                    <p class=\"font-bold\">Dirigido a:</p>\n                    <span>{{ rowData.Cliente }}</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </template>\n\n          <template #bodyAppend>\n            <tr>\n              <td colspan=\"9\">\n                <div class=\"flex justify-end mt-4\">\n                  <VaPagination\n                    v-model=\"currentPage\"\n                    size=\"small\"\n                    class=\"text-xs mb-3 justify-center sm:justify-start\"\n                    buttons-preset=\"primary\"\n                    active-page-color=\"textPrimary\"\n                    :pages=\"pages()\"\n                  />\n                </div>\n              </td>\n            </tr>\n          </template>\n        </VaDataTable>\n      </div>\n    </div>\n\n    <VaModal v-model=\"showConfirm\" size=\"250px\" hide-default-actions no-dismiss>\n      <p class=\"text-sm\">¿Deseas eliminar esta cotización?</p>\n      <template #footer>\n        <VaButton size=\"small\" preset=\"secondary\" class=\"mr-1\" @click=\"showConfirm = null\"> Cancelar</VaButton>\n        <VaButton size=\"small\" :loading=\"isDeleting\" @click=\"doDelete\"> Continuar</VaButton>\n      </template>\n    </VaModal>\n\n    <VaModal v-model=\"showConfirmStatus\" size=\"250px\" hide-default-actions no-dismiss>\n      <p class=\"text-sm\">¿Deseas cambiar el estado de esta cotización?</p>\n      <template #footer>\n        <VaButton size=\"small\" preset=\"secondary\" class=\"mr-1\" @click=\"cancelStatus()\"> Cancelar</VaButton>\n        <VaButton size=\"small\" :loading=\"isOnChangeStatus\" @click=\"doChangeStatus\"> Continuar</VaButton>\n      </template>\n    </VaModal>\n\n    <VaModal v-model=\"viewOrders\" size=\"280px\" hide-default-actions close-button>\n      <p v-if=\"orders.length > 1\" class=\"text-sm\">Ordenes registradas:</p>\n      <p v-if=\"orders.length == 1\" class=\"text-sm\">Orden registrada:</p>\n      <ul class=\"list-decimal px-4 text-sm mt-3\">\n        <li v-for=\"order of orders\" :key=\"order\" class=\"mb-2\">\n          <span class=\"font-bold\">000{{ order }}-24</span>\n          <VaButton\n            size=\"small\"\n            preset=\"primary\"\n            :to=\"'/orders/view/' + order\"\n            class=\"ml-1\"\n            style=\"text-transform: capitalize; top: -2px\"\n            @click=\"orderStore.hideOrders()\"\n          >\n            Ver Orden\n          </VaButton>\n        </li>\n      </ul>\n    </VaModal>\n\n    <VaModal v-model=\"showNewOportunity\" hide-default-actions size=\"medium\" close-button blur no-dismiss>\n      <div class=\"mt-4\">\n        <NewOportunity @close=\"closeNew\" />\n      </div>\n    </VaModal>\n\n    <VaModal v-model=\"showEdit\" hide-default-actions size=\"medium\" close-button blur no-dismiss>\n      <div class=\"mt-4\">\n        <NewOportunity :data=\"showEdit\" :detail=\"onlyPreview\" @close=\"closeNew\" />\n      </div>\n    </VaModal>\n  </div>\n</template>\n"],"names":["notify","useToast","router","useRouter","items","ref","columns","orderStore","useOrdersStore","viewOrders","orders","storeToRefs","oportunityStore","useOportunitiesStore","statusOptions","showConfirm","showConfirmStatus","showEdit","onlyPreview","showNewOportunity","isDeleting","isLoading","isOnChangeStatus","inputSearch","startDate","filteredCount","perPage","currentPage","pages","doDelete","deleteOportunity","getData","filter","data","getAllOportunities","e","state","format","_a","openPreview","item","closeNew","onChangeStatus","cancelStatus","doChangeStatus","onMounted","watch","openOrder","id","order","newOrder","newOrders","exists","doFilterByRange","start","end","fromDate","toDate","isDownloading","download","isLoadingPDF","togglePdfLoading"],"mappings":"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"}